@using Newtonsoft.Json;
@inject IHttpContextAccessor HttpContextAccessor
@model IEnumerable< TmEmpCreditVM>

@{
    Layout = "_Layout_main";
}
@{
    var permissions = new List<KeyValuePair<string, string>>();

    // استرجاع الصلاحيات من الجلسة إذا كانت موجودة
    var permissionsJson = HttpContextAccessor.HttpContext.Session.GetString("UserPermissions");

    if (!string.IsNullOrEmpty(permissionsJson))
    {
        permissions = JsonConvert.DeserializeObject<List<KeyValuePair<string, string>>>(permissionsJson);
    }

    // التحقق من وجود صلاحيات معينة
    bool canRole = permissions.Any(c => c.Key == "Permission" && c.Value == "Permissions.Role.View");
    bool canEdit = permissions.Any(c => c.Key == "Permission" && c.Value == "Permissions.StaffManagement.Edit");
    bool canDelete = permissions.Any(c => c.Key == "Permission" && c.Value == "Permissions.StaffManagement.Delete");
}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12 pt-3">
            <header class="header-filter">
                <div class="group-filter d-flex">
                    <div class="input-group me-3">
                        <input id="txtSearch" class="form-control" type="search" placeholder="Search" aria-label="Recipient's username" aria-describedby="button-addon2">
                        <button class="btn btn-outline-master" id="button-addon2" type="button" onclick="DashboardSearch()"> <i class="fa-solid fa-magnifying-glass"></i></button>
                    </div>
                    <button class="btn btn-outline-master d-flex align-items-center" type="button" data-bs-toggle="modal" data-bs-target="#exampleModal"> <i class="fa-solid fa-arrow-down-wide-short me-2"></i>Filter</button>
                </div>
                <div class="date">
                    @ViewBag.DisplayCurrntDate
                </div>
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle rounded-pill btn-master" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa-solid fa-plus me-2"></i> Create
                    </button>
                    <ul class="dropdown-menu bg-primary text-white">
                        @if (permissions != null && permissions.Any(c => c.Key == "Permission" && c.Value == "Permissions.CreateOrders.Create"))
                        {
                            <li><a class="dropdown-item text-white" asp-controller="CreateOrders" asp-action="Index"><i class="fa-solid fa-plus me-2"></i> Order</a></li>
                        }
                        @if (permissions != null && permissions.Any(c => c.Key == "Permission" && c.Value == "Permissions.InspectionOrder.Create"))
                        {
                            <li><a class="dropdown-item text-white" asp-controller="InspectionOrder" asp-action="InspectionOrder"><i class="fa-solid fa-plus me-2"></i> Room inspiction</a></li>
                        }
                    </ul>
                </div>
            </header>
        </div>
    </div>
</div>
<div class="rooms-status" id="pageMasterLoad">
    <div class="container-fluid pt-3">
        <header class="header-filter align-items-end">
            <div class="over-view w-50" style="--Num-columns-xl: 3; --Num-columns-md: 3 ; --Num-columns-sm: 2 ">
                <div class="card-item" style="--main-color: #ede6f9">
                    <h3 class="number" id="TotalDepartment">@ViewBag.TotalDepartment </h3>
                    <div class="title"> <i class="fa-solid fa-user-tie"></i><span class="text">Total Employees</span></div>
                </div>
                @*                 <div class="card-item vip" style="--main-color: #fadec9">
                <h3 class="number">17 </h3>
                <div class="title"> <i class="fa-solid fa-building-user"></i><span class="text">Annual leave </span></div>
                </div> *@
            </div>
            @*             <div class="group-filter d-flex">
            <div class="input-group me-3">
            <input class="form-control" type="search" placeholder="Search" aria-label="Recipient's username" aria-describedby="button-addon2">
            <button class="btn btn-outline-master" id="button-addon2" type="button"> <i class="fa-solid fa-magnifying-glass"></i></button>
            </div>
            </div> *@
        </header>
        <div style="display:none;">
            <select id="ddlDepartments" class="form-select rounded-pill">
            </select>
            <input type="hidden" id="hfDepartmentId" />
        </div>
        <table class="table table-hover table-responsive-scroll data-Tables table-striped" id="dataTableShift">
            <thead>
                <tr>
                    <th style='width: 15%' scope="col">Name</th>
                    <th style='' scope="col">UF Shift Status</th>
                    <th style='width:7%;text-wrap:nowrap;' scope="col">Max Credits</th>
                    <th style='width:7%;text-wrap:nowrap;' scope="col">Max zones</th>
                    <th style='width:7%;text-wrap:nowrap;' scope="col">Room Sets</th>
                    <th style='' scope="col">Shift Type </th>
                    <th style='' scope="col">Weekend</th>
                    <th scope="col">Notes</th>
                </tr>
            </thead>
            <tbody>
                @{
                    if (Model != null)
                    {
                        foreach (var item in Model)
                        {
                                <tr>
                                    <td class="align-middle" data-label="Name">
                                        <label class="d-block w-100" for="1">@item.EmpName</label>
                                        <input type="hidden" id="hfEmpId" value="@item.EmpId" />
                                        <input type="hidden" id="hfUFShiftId" value="@item.UFShiftId" />
                                    </td>
                                    <td data-label="UF Shift Status">
                                        <input class="form-control" type="Text" name="" value="@item.UFShiftStatus">
                                    </td>
                                    <td data-label="Max Credits">
                                        <input class="form-control" type="number" name="" value="@item.MaxCredits">
                                    </td>
                                    <td data-label="Max zones">
                                        <input class="form-control" type="number" name="" value="@item.MaxZones">
                                    </td>
                                    <td data-label="Room Sets">
                                        <input class="form-control" type="number" name="" value="@item.RoomSets">
                                    </td>
                                    <td data-label="Shift Type ">
                                        <select class="form-select" aria-label="Default select example" asp-for="@item.ShiftTypeId">
                                            <option value="1" selected>MS</option>
                                            <option value="2">ES</option>
                                            <option value="3">NS</option>
                                        </select>
                                    </td>
                                    <td data-label="Weekend">
                                        <select class="form-select" aria-label="Default select example" asp-for="@item.Weekend">
                                            <option value="1">Sunday</option>
                                            <option value="2">Monday</option>
                                            <option value="3">Tuesday</option>
                                            <option value="4">Wednesday</option>
                                            <option value="5">Thursday</option>
                                            <option value="6">Friday</option>
                                            <option value="7">Saturday</option>
                                        </select>
                                    </td>
                                    <td data-label="Notes">
                                        <textarea class="form-control" id="exampleFormControlTextarea1" rows="1">@item.sNotes</textarea>
                                    </td>
                                </tr>
                        }
                    }
                    else
                    {
                            <tr>
                                <td colspan="9">
                                    <span>Not found records</span>
                                </td>
                            </tr>
                    }
                }
            </tbody>
        </table>
        <div class="d-flex justify-content-end"><a class="btn btn-master rounded-pill w-25" onclick="saveEmployeesCredits()">Save            </a></div>
        <div class="container-room"> </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            //var ddlDepartments = $("#ddlDepartments");
            //FillDepartment(ddlDepartments);

            //GetDepartment();

        });
        function FillDepartment(ddlobject) {
            $.ajax({
                url: '@Url.Action("GetDepartment", "Items")',
                type: "GET",
                dataType: "json",
                cache: false,
                success: function (result) {
                    if (result.success) {
                        ddlobject.empty();
                        //ddlobject.append($("<option></option>")
                        //    .attr("value", "0")
                        //    .text("Select Department"));
                        result.returnData.forEach(function (item) {
                            ddlobject.append($("<option></option>")
                                .attr("value", item.value)
                                .text(item.text));
                        });
                    } else {
                        ShowMsgError(result.message);
                    }
                },
                error: function (err) {
                    return false;
                }
            });
        }
        function GetDepartment() {

            var hfDepartmentId = $("#hfDepartmentId");

            $.ajax({
                url: '@Url.Action("GetDepartmentHK", "TimeManagement")',
                type: "GET",
                dataType: "json",
                cache: false,
                success: function (result) {
                    if (result.success) {
                        hfDepartmentId.val(result.returnData);
                    } else {
                        hfDepartmentId.val();
                    }
                },
                error: function (err) {
                    return false;
                }
            });
        }


        function saveEmployeesCredits() {
            var employeesCredits = [];

            $('#dataTableShift tbody tr').each(function () {
                var employee = {
                    EmpName: $(this).find('label').text(),  // أخذ اسم الموظف من الـ label
                    EmpId: $(this).find('input[id="hfEmpId"]').val(),  // أخذ الـ EmpId من الـ input المخفي
                    UFShiftId: $(this).find('input[id="hfUFShiftId"]').val(),  // أخذ الـ UFShiftId من الـ input المخفي
                    UFShiftStatus: $(this).find('input[type="text"]').val(),  // أخذ حالة الشيفت من input text
                    MaxCredits: $(this).find('input[type="number"]').eq(0).val(),  // أخذ Max Credits من input number الأول
                    MaxZones: $(this).find('input[type="number"]').eq(1).val(),  // أخذ Max Zones من input number الثاني
                    RoomSets: $(this).find('input[type="number"]').eq(2).val(),  // أخذ Room Sets من input number الثالث
                    ShiftTypeId: $(this).find('select').eq(0).val(),  // أخذ نوع الشيفت من select الأول
                    Weekend: $(this).find('select').eq(1).val(),  // أخذ عطلة نهاية الأسبوع من select الثاني
                    sNotes: $(this).find('textarea').val()  // أخذ الملاحظات من textarea
                };
                console.log(employee);
                employeesCredits.push(employee);
            });

            $.ajax({
                url: '@Url.Action("SaveEmployeesCredits", "TimeManagement")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(employeesCredits),
                success: function (response) {
                    if (response.success) {
                        ShowMsgSucces('Data saved successfully!');
                        window.location.href = "/TimeManagement/ShiftEmployees";
                    } else {
                        ShowMsgError('Error saving data');
                    }
                },
                error: function (error) {
                    //console.log(error);
                    ShowMsgError('An error occurred while saving data');
                }
            });
        }
    </script>
}